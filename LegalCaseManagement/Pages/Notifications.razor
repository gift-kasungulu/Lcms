@page "/notifications"

@attribute [Authorize(Roles = "Admin, Client, Team")]

@using LegalCaseManagement.Data
@using LegalCaseManagement.Service
@using LegalCaseManagement.Domain
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject AppointmentService AppointmentService
@inject NotificationService NotificationService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject EmailService EmailService 

<PageTitle>Notifications</PageTitle>

<MudGrid>
    <MudItem xs="12">
        <MudText Typo="Typo.h5">Notifications</MudText>
    </MudItem>
</MudGrid>
<MudDivider Class="my-2" />

<MudList Dense="true">
    @foreach (var notification in notifications)
    {
        <MudListItem>
            <MudGrid>
                <MudItem xs="10">
                    <MudText Typo="Typo.body1">@notification.Message</MudText>
                </MudItem>
                <MudItem xs="2" Class="d-flex justify-end">
                    <MudText Typo="Typo.caption">@notification.CreatedAt.ToLocalTime().ToString("g")</MudText>
                </MudItem>
            </MudGrid>
            <MudButton Color="Color.Primary" OnClick="@(() => MarkAsRead(notification.Id))">Mark as Read</MudButton>
        </MudListItem>
        <MudDivider />
    }
</MudList>

@if (isAdmin)
{
    <MudText Typo="Typo.h6" Class="mt-4">Pending Appointments</MudText>
    <MudList Dense="true">
        @foreach (var appointment in appointments)
        {
            <MudListItem>
                <MudGrid>
                    <MudItem xs="10">
                        <MudText Typo="Typo.body1">@notificationMessages[appointment.Id]</MudText>
                    </MudItem>
                    <MudItem xs="2" Class="d-flex justify-end">
                        <MudText Typo="Typo.caption">@appointment.Date.ToShortDateString()</MudText>
                    </MudItem>
                </MudGrid>
                <MudButton Color="Color.Success" OnClick="@(() => ApproveAppointment(appointment.Id))">Approve</MudButton>
            </MudListItem>
            <MudDivider />
        }
    </MudList>
}
else
{
    <MudText Typo="Typo.h6" Class="mt-4">Approved Appointments</MudText>
    <MudList Dense="true">
        @foreach (var appointment in appointments)
        {
            <MudListItem>
                <MudGrid>
                    <MudItem xs="10">
                        <MudText Typo="Typo.body1">@notificationMessages[appointment.Id]</MudText>
                    </MudItem>
                    <MudItem xs="2" Class="d-flex justify-end">
                        <MudText Typo="Typo.caption">@appointment.Date.ToShortDateString()</MudText>
                    </MudItem>
                </MudGrid>
            </MudListItem>
            <MudDivider />
        }
    </MudList>
}

@code {
    private List<Appointment> appointments = new List<Appointment>();
    private Dictionary<int, string> notificationMessages = new Dictionary<int, string>();
    private List<Notification> notifications = new List<Notification>();
    private bool isAdmin = false;

    protected override async Task OnInitializedAsync()
    {
        var user = await UserManager.GetUserAsync(SignInManager.Context.User);
        if (user == null)
        {
            return;
        }

        var roles = await UserManager.GetRolesAsync(user);
        isAdmin = roles.Contains("Admin");

        if (isAdmin)
        {
            appointments = (await AppointmentService.GetPendingAppointments()).ToList();
        }
        else if (roles.Contains("Team"))
        {
            appointments = (await AppointmentService.GetAppointmentsByTeamMember(user.Id)).ToList();
        }
        else if (roles.Contains("Client"))
        {
            appointments = (await AppointmentService.GetAppointmentsByClient(user.Id)).ToList();
        }

        await LoadNotificationMessages();
        notifications = await NotificationService.GetUnreadNotificationsForUser(user.Id);
    }

    private async Task LoadNotificationMessages()
    {
        foreach (var appointment in appointments)
        {
            var message = await GetNotificationMessage(appointment);
            notificationMessages[appointment.Id] = message;
        }
    }

    private async Task<string> GetNotificationMessage(Appointment appointment)
    {
        var creator = await UserManager.FindByIdAsync(appointment.CreatedBy);
        if (creator == null)
        {
            return $"Appointment on {appointment.Date.ToShortDateString()} (creator not found)";
        }
        var roles = await UserManager.GetRolesAsync(creator);
        if (roles.Contains("Client"))
        {
            return $"Appointment with Client {creator.UserName} on {appointment.Date.ToShortDateString()}";
        }
        else if (roles.Contains("Team"))
        {
            return $"Appointment with Lawyer {creator.UserName} on {appointment.Date.ToShortDateString()}";
        }
        else
        {
            return $"Appointment on {appointment.Date.ToShortDateString()}";
        }
    }

    private async Task MarkAsRead(int notificationId)
    {
        await NotificationService.MarkAsRead(notificationId);
        notifications = notifications.Where(n => n.Id != notificationId).ToList();
        StateHasChanged();
    }

    private async Task ApproveAppointment(int appointmentId)
    {
        var appointment = appointments.FirstOrDefault(a => a.Id == appointmentId);
        if (appointment == null)
        {
            Snackbar.Add("Appointment not found", Severity.Error);
            return;
        }

        // Approve the appointment
        await AppointmentService.ApproveAppointment(appointmentId);
        appointments = appointments.Where(a => a.Id != appointmentId).ToList();
        StateHasChanged();

        // Get the creator of the appointment
        var creator = await UserManager.FindByIdAsync(appointment.CreatedBy);
        var client = await UserManager.FindByIdAsync(appointment.UserId);
        var lawyer = await UserManager.FindByIdAsync(appointment.User.Id);

        if (creator == null)
        {
            Snackbar.Add("Appointment creator not found", Severity.Warning);
            return;
        }

        // Determine if the creator is a lawyer or client and send email accordingly
        var roles = await UserManager.GetRolesAsync(creator);
        if (roles.Contains("Team") && client != null)
        {
            // Send email to the client
            var subject = "Appointment Confirmation";
            var body = $"Dear {client.FirstName} {client.LastName},<br><br>" +
                       $"Your appointment has been confirmed:<br>" +
                       $"Advocates: {creator.FirstName} {creator.LastName}<br>" +
                       $"Date: {appointment.Date.ToShortDateString()}<br>" +
                       $"Time: {appointment.Time}<br><br>" +
                       $"Please log in to the system to view more details.<br><br>" +
                       $"Best regards,<br>Legal Case Management System";

            try
            {
                await EmailService.SendEmailAsync(client.Email, subject, body);
                Snackbar.Add("Client notified successfully", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Failed to send email to client: {ex.Message}", Severity.Warning);
            }
        }
        else if (roles.Contains("Client") && lawyer != null)
        {
            // Send email to the lawyer
            var subject = "New Appointment Scheduled";
            var body = $"Dear {lawyer.FirstName} {lawyer.LastName},<br><br>" +
                       $"You have a new appointment scheduled:<br>" +
                       $"Client: {creator.FirstName} {creator.LastName}<br>" +
                       $"Date: {appointment.Date.ToShortDateString()}<br>" +
                       $"Time: {appointment.Time}<br><br>" +
                       $"Please log in to the system to view more details.<br><br>" +
                       $"Best regards,<br>Legal Case Management System";

            try
            {
                await EmailService.SendEmailAsync(lawyer.Email, subject, body);
                Snackbar.Add("Lawyer notified successfully", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Failed to send email to lawyer: {ex.Message}", Severity.Warning);
            }
        }
        else
        {
            Snackbar.Add("No valid recipient found for the appointment notification.", Severity.Warning);
        }
    }



}
